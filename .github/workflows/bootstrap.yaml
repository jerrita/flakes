name: Build NixOS Bootstrap

on:
  push:
    paths:
      - '.github/workflows/bootstrap.yaml'
      - 'hosts/bootstrap/**'
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Nix
      uses: cachix/install-nix-action@v27
      with:
        github_access_token: ${{ secrets.GITHUB_TOKEN }}

    - name: Build nixos-bootstrap
      run: |
        nix build .#image.vda -L
        cp result/main.raw nixos-bootstrap-vda
        xz nixos-bootstrap-vda
        nix build .#image.sda -L
        cp result/main.raw nixos-bootstrap-sda
        xz nixos-bootstrap-sda

    - name: Release
      uses: svenstaro/upload-release-action@v2
      with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          tag: "bootstrap"
          file: ./nixos-bootstrap-*.xz
          overwrite: true
